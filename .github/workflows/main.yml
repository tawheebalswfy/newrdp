name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Core RDP Settings
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
            -Name "fDenyTSConnections" -Value 0 -Force

          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
            -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
            -Name "SecurityLayer" -Value 0 -Force

          netsh advfirewall firewall delete rule name="RDP-Tailscale" | Out-Null
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force

      - name: Create RDP User with Secure Password
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          $upper=[char[]](65..90)
          $lower=[char[]](97..122)
          $num=[char[]](48..57)
          $spec=([char[]](33..47)+[char[]](58..64)+[char[]](91..96)+[char[]](123..126))

          $pw = -join( @(
            $upper | Get-Random -Count 4
            $lower | Get-Random -Count 4
            $num   | Get-Random -Count 4
            $spec  | Get-Random -Count 4
          ) | Sort-Object {Get-Random} )

          $secure = ConvertTo-SecureString $pw -AsPlainText -Force

          if (-not (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name "RDP" -Password $secure -AccountNeverExpires | Out-Null
          } else {
            Set-LocalUser -Name "RDP" -Password $secure
          }

          Add-LocalGroupMember -Group "Administrators" -Member "RDP" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP" -ErrorAction SilentlyContinue

          echo "RDP_USER=RDP" >> $env:GITHUB_ENV
          echo "RDP_PASS=$pw"  >> $env:GITHUB_ENV

      - name: Verify required files exist in repo
        shell: powershell
        run: |
          Write-Host "Repo root content:"
          Get-ChildItem -Force

          if (-not (Test-Path ".\MQL4.zip")) { Write-Error "MQL4.zip not found in repo root"; exit 1 }
          if (-not (Test-Path ".\MQL5.zip")) { Write-Error "MQL5.zip not found in repo root"; exit 1 }
          if (-not (Test-Path ".\mt4setup.exe")) { Write-Error "mt4setup.exe not found in repo root"; exit 1 }

      - name: Install MT5 (winget) + MT4 (from repo) with timeouts
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          $dl = "C:\Installers"
          New-Item -ItemType Directory -Force $dl | Out-Null

          # -------------------------
          # MT5 via winget (more reliable)
          # -------------------------
          Write-Host "Installing MT5 via winget..."
          try {
            winget source update | Out-Null
            winget install --id MetaQuotes.MetaTrader5 -e --accept-source-agreements --accept-package-agreements
            Write-Host "MT5 winget install finished."
          } catch {
            Write-Warning "MT5 winget install failed: $($_.Exception.Message)"
          }

          # Find MT5 terminal64.exe
          $mt5Candidates = @(
            "C:\Program Files\MetaTrader 5",
            "C:\Program Files (x86)\MetaTrader 5",
            "$env:LOCALAPPDATA\Programs\MetaTrader 5",
            "$env:APPDATA\MetaQuotes\Terminal"
          )

          $mt5Term = $null
          foreach ($c in $mt5Candidates) {
            if (Test-Path $c) {
              $found = Get-ChildItem -Path $c -Recurse -Filter "terminal64.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($found) { $mt5Term = $found; break }
            }
          }

          if (-not $mt5Term) {
            Write-Host "MT5 not found via winget. Will download installer and start interactive mode in RDP."

            $mt5Url = "https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/mt5setup.exe"
            $mt5Exe = Join-Path $dl "mt5setup.exe"
            Invoke-WebRequest -Uri $mt5Url -OutFile $mt5Exe -UseBasicParsing

            Start-Process -FilePath $mt5Exe
            Write-Warning "MT5 installer started interactively. Finish it inside RDP."
          } else {
            echo "MT5_TERMINAL=$($mt5Term.FullName)" >> $env:GITHUB_ENV
            Write-Host "MT5 terminal: $($mt5Term.FullName)"
          }

          # -------------------------
          # MT4 from repo (mt4setup.exe) with timeout
          # -------------------------
          $mt4Exe = Join-Path $dl "mt4setup.exe"
          Copy-Item ".\mt4setup.exe" $mt4Exe -Force
          Write-Host "Installing MT4 from repo (mt4setup.exe)..."

          $p4 = Start-Process -FilePath $mt4Exe -ArgumentList "/silent","/verysilent","/sp-","/suppressmsgboxes" -PassThru
          $timeoutSec = 180  # 3 minutes
          if (-not $p4.WaitForExit($timeoutSec * 1000)) {
            Write-Warning "MT4 silent install timed out. Starting interactive installer for RDP..."
            try { $p4.Kill() } catch {}
            Start-Process -FilePath $mt4Exe
            Write-Warning "MT4 installer started interactively. Finish it inside RDP."
          } else {
            Write-Host "MT4 exit code: $($p4.ExitCode)"
          }

          # Find MT4 terminal.exe
          $mt4Candidates = @(
            "C:\MT4",
            "C:\Program Files\MetaTrader 4",
            "C:\Program Files (x86)\MetaTrader 4",
            "$env:LOCALAPPDATA\Programs\MetaTrader 4",
            "$env:APPDATA\MetaQuotes\Terminal",
            "C:\Program Files\",
            "C:\Program Files (x86)\"
          )

          $mt4Term = $null
          foreach ($c in $mt4Candidates) {
            if (Test-Path $c) {
              $found = Get-ChildItem -Path $c -Recurse -Filter "terminal.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($found) { $mt4Term = $found; break }
            }
          }

          if ($mt4Term) {
            echo "MT4_TERMINAL=$($mt4Term.FullName)" >> $env:GITHUB_ENV
            Write-Host "MT4 terminal: $($mt4Term.FullName)"
          } else {
            Write-Warning "MT4 terminal not found yet. If installer is open, finish it inside RDP."
          }

      - name: Initialize MT4/MT5 in PORTABLE mode (creates MQL folders in install dir)
        shell: powershell
        run: |
          $ErrorActionPreference = "Continue"

          if ($env:MT5_TERMINAL -and (Test-Path $env:MT5_TERMINAL)) {
            Start-Process -FilePath $env:MT5_TERMINAL -ArgumentList "/portable" -WindowStyle Hidden
            Start-Sleep -Seconds 12
            Get-Process terminal64 -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
          } else {
            Write-Warning "Skipping MT5 portable init (MT5 terminal not detected)."
          }

          if ($env:MT4_TERMINAL -and (Test-Path $env:MT4_TERMINAL)) {
            Start-Process -FilePath $env:MT4_TERMINAL -ArgumentList "/portable" -WindowStyle Hidden
            Start-Sleep -Seconds 12
            Get-Process terminal -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
          } else {
            Write-Warning "Skipping MT4 portable init (MT4 terminal not detected)."
          }

      - name: Extract and copy MQL4.zip & MQL5.zip to PORTABLE folders
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          function Extract-MQLZip {
            param(
              [string]$ZipPath,
              [string]$TargetMqlDir,
              [string]$Label
            )

            New-Item -ItemType Directory -Force $TargetMqlDir | Out-Null

            $tmp = Join-Path $env:TEMP ("mql_" + [Guid]::NewGuid().ToString("N"))
            New-Item -ItemType Directory -Force $tmp | Out-Null

            Write-Host "[$Label] Expand: $ZipPath -> $tmp"
            Expand-Archive -Path $ZipPath -DestinationPath $tmp -Force

            $mql4 = Join-Path $tmp "MQL4"
            $mql5 = Join-Path $tmp "MQL5"

            if (Test-Path $mql4) {
              Copy-Item (Join-Path $mql4 "*") -Destination $TargetMqlDir -Recurse -Force
            } elseif (Test-Path $mql5) {
              Copy-Item (Join-Path $mql5 "*") -Destination $TargetMqlDir -Recurse -Force
            } else {
              Copy-Item (Join-Path $tmp "*") -Destination $TargetMqlDir -Recurse -Force
            }

            Remove-Item $tmp -Recurse -Force -ErrorAction SilentlyContinue

            Write-Host "[$Label] Done. Listing target (top level):"
            Get-ChildItem -Path $TargetMqlDir -Force | Select-Object Name
          }

          # MT5
          if ($env:MT5_TERMINAL -and (Test-Path $env:MT5_TERMINAL)) {
            $mt5Root = Split-Path $env:MT5_TERMINAL -Parent
            $mt5Mql  = Join-Path $mt5Root "MQL5"
            Extract-MQLZip -ZipPath ".\MQL5.zip" -TargetMqlDir $mt5Mql -Label "MT5"
          } else {
            Write-Warning "MT5 not detected, so MQL5.zip was not copied."
          }

          # MT4
          if ($env:MT4_TERMINAL -and (Test-Path $env:MT4_TERMINAL)) {
            $mt4Root = Split-Path $env:MT4_TERMINAL -Parent
            $mt4Mql  = Join-Path $mt4Root "MQL4"
            Extract-MQLZip -ZipPath ".\MQL4.zip" -TargetMqlDir $mt4Mql -Label "MT4"
          } else {
            Write-Warning "MT4 not detected, so MQL4.zip was not copied."
          }

      - name: Install Tailscale
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $msi = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $msi -UseBasicParsing
          Start-Process msiexec.exe -ArgumentList "/i", "`"$msi`"", "/quiet", "/norestart" -Wait
          Remove-Item $msi -Force

      - name: Establish Tailscale Connection
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          if (-not "${{ secrets.TAILSCALE_AUTH_KEY }}") { Write-Error "Missing TAILSCALE_AUTH_KEY secret"; exit 1 }

          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID

          $ip=$null; $i=0
          while (-not $ip -and $i -lt 30) {
            $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            Start-Sleep -Seconds 2
            $i++
          }
          if (-not $ip) { Write-Error "No Tailscale IP"; exit 1 }

          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "Tailscale IP: $ip"

      - name: Verify RDP Accessibility
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $r = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
          if (-not $r.TcpTestSucceeded) { Write-Error "RDP port test failed"; exit 1 }
          Write-Host "RDP port OK."

      - name: Maintain Connection
        shell: powershell
        run: |
          Write-Host "`n=== RDP ACCESS ==="
          Write-Host "Address : $env:TAILSCALE_IP"
          Write-Host "Username: $env:RDP_USER"
          Write-Host "Password: $env:RDP_PASS"
          Write-Host "==================`n"

          while ($true) {
            Write-Host "[$(Get-Date)] RDP Active"
            Start-Sleep -Seconds 300
          }
