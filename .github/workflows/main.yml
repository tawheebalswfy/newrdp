name: RDP

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: write

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      # 1) تحميل ملفات الريبو فقط
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) نسخ الملفات المرفوعة إلى C:\Installers
      - name: Prepare installers (repo files only)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $dst = "C:\Installers"
          New-Item -ItemType Directory -Force $dst | Out-Null

          $files = @("MQL4.zip","MQL5.zip","mt4setup.exe")
          foreach ($f in $files) {
            $src = Join-Path $env:GITHUB_WORKSPACE $f
            if (Test-Path $src) {
              Copy-Item $src -Destination $dst -Force
            }
          }
          Get-ChildItem $dst

      # 3) تفعيل RDP
      - name: Enable RDP
        shell: powershell
        run: |
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
            -Name fDenyTSConnections -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          Restart-Service TermService -Force

      # 4) إنشاء مستخدم RDP
      - name: Create RDP user
        shell: powershell
        run: |
          $pass = -join ((33..126) | Get-Random -Count 20 | % {[char]$_})
          $sec = ConvertTo-SecureString $pass -AsPlainText -Force

          if (Get-LocalUser -Name RDP -ErrorAction SilentlyContinue) {
            Set-LocalUser RDP -Password $sec
          } else {
            New-LocalUser RDP -Password $sec -AccountNeverExpires
          }

          Add-LocalGroupMember Administrators RDP -ErrorAction SilentlyContinue
          Add-LocalGroupMember "Remote Desktop Users" RDP -ErrorAction SilentlyContinue

          "RDP_USER=RDP" >> $env:GITHUB_ENV
          "RDP_PASS=$pass" >> $env:GITHUB_ENV

      # 5) تثبيت Tailscale
      - name: Install Tailscale
        shell: powershell
        run: |
          $msi="$env:TEMP\tailscale.msi"
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /quiet /norestart" -Wait

      # 6) تشغيل Tailscale
      - name: Start Tailscale
        shell: powershell
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --hostname=gh-$env:GITHUB_RUN_ID

          $ip=""
          for($i=0;$i -lt 12;$i++){
            $ip=& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if($ip){break}
            Start-Sleep 5
          }
          if(!$ip){exit 1}
          "TS_IP=$ip" >> $env:GITHUB_ENV

      # 7) حفظ البيانات المهمة (Persist)
      - name: Persist data
        shell: powershell
        run: |
          $p="$env:GITHUB_WORKSPACE\persist"
          New-Item -ItemType Directory -Force $p | Out-Null
          Copy-Item C:\Installers $p\Installers -Recurse -Force -ErrorAction SilentlyContinue

      # 8) رفع النسخة الاحتياطية
      - name: Upload backup
        uses: actions/upload-artifact@v4
        with:
          name: persist-backup
          path: persist
          retention-days: 7

      # 9) عرض معلومات الدخول
      - name: Show RDP info
        shell: powershell
        run: |
          Write-Host "RDP IP : $env:TS_IP"
          Write-Host "USER   : $env:RDP_USER"
          Write-Host "PASS   : $env:RDP_PASS"

      # 10) إبقاء الجلسة + إعادة تشغيل تلقائي
      - name: Keep alive & auto-restart
        shell: powershell
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          $start=Get-Date
          while($true){
            $m=((Get-Date)-$start).TotalMinutes
            if($m -ge 315){
              $repo=$env:GITHUB_REPOSITORY
              $url="https://api.github.com/repos/$repo/actions/workflows/main.yml/dispatches"
              $body=@{ref=$env:GITHUB_REF_NAME}|ConvertTo-Json
              Invoke-RestMethod -Method Post -Uri $url `
                -Headers @{Authorization="token $env:GH_PAT"} `
                -Body $body
              break
            }
            Start-Sleep 300
          }
